# manifests/03-api-gateway/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: microservices-demo
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    
    http {
      upstream user_service {
        server user-service:8000;
        server user-service:8000;
      }
      
      server {
        listen 8080;
        
        location /health {
          return 200 '{"status": "ok", "service": "api-gateway"}';
          add_header Content-Type application/json;
        }
        
        location /users {
          proxy_pass http://user_service;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /metrics {
          proxy_pass http://user_service/metrics;
        }
        
        location / {
          return 404 '{"error": "Not found"}';
          add_header Content-Type application/json;
        }
      }
    }