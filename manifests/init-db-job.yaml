# manifests/init-db-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: init-database
  namespace: microservices-demo
spec:
  template:
    spec:
      containers:
      - name: init-db
        image: postgres:14-alpine
        env:
        - name: PGHOST
          value: postgres
        - name: PGDATABASE
          value: microservices
        - name: PGUSER
          value: admin
        - name: PGPASSWORD
          value: admin123
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if pg_isready -h postgres -p 5432; then
              echo "PostgreSQL is ready!"
              
              # Создаем тестовые данные
              psql -c "
                CREATE TABLE IF NOT EXISTS users (
                  id SERIAL PRIMARY KEY,
                  name VARCHAR(100) NOT NULL,
                  email VARCHAR(100) UNIQUE NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
                
                INSERT INTO users (name, email) VALUES
                  ('John Doe', 'john@example.com'),
                  ('Jane Smith', 'jane@example.com'),
                  ('Bob Johnson', 'bob@example.com')
                ON CONFLICT (email) DO NOTHING;
                
                SELECT 'Database initialized successfully' as message;
              "
              exit 0
            fi
            echo "Waiting for PostgreSQL... attempt $i"
            sleep 2
          done
          echo "Failed to connect to PostgreSQL"
          exit 1
      restartPolicy: Never
  backoffLimit: 3